<!--
<app-topnav>
    <ng-container dynamic-section>
        <div fxLayout="row" fxFlex fxLayoutAlign="space-between center">
            <app-breadcrumbs [items]="breadcrumbs"></app-breadcrumbs>
        </div>
    </ng-container>
</app-topnav>
-->

<!-- Total number of records from the list -->
<!--<app-total-number-of-records-->
<!--    [value]="duplicatesListCount$ | async">-->
<!--</app-total-number-of-records>-->

<mat-card class="page-section page-content">
    <div class="reset-filters">
        <button
            type="button"
            mat-raised-button
            color="accent"
            (click)="needsRefreshList(true)">
            {{ 'LNG_COMMON_BUTTON_REFRESH_LIST' | translate }}
        </button>
    </div>

    <!-- Loading data data -->
    <div
        *ngIf="!duplicatesList"
        class="duplicate-records-loading">
        <mat-spinner></mat-spinner>
    </div>

    <ng-container
        *ngIf="duplicatesList">
        <div
            *ngFor="let group of duplicatesList.groups"
            class="duplicate-records-tables">
            <form
                #tableForm="ngForm">
                <div
                    fxFlex fxLayout="row" fxLayoutGap="20px">
                    <div
                        fxFlex>
                        <mat-table [dataSource]="group.peopleIds">
                            <!-- Checkbox -->
                            <ng-container matColumnDef="checkbox">
                                <mat-header-cell *matHeaderCellDef fxFlex="60px">
                                    <div class="table-header-cell">
                                        <div
                                            *ngIf="hasMergePermission(group)">
                                            <app-form-checkbox
                                                class="table-checkbox"
                                                name="checkAll"
                                                ngModel
                                                (optionChanged)="checkAllToggle(tableForm)">
                                            </app-form-checkbox>
                                        </div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item;" fxFlex="60px">
                                    <app-form-checkbox
                                        *ngIf="hasMergePermission(group)"
                                        #listCheckedIndividual
                                        [name]="'recordCheck[' + item + ']'"
                                        class="table-checkbox"
                                        ngModel
                                        (optionChanged)="checkOneToggle(tableForm)">
                                    </app-form-checkbox>
                                </mat-cell>
                            </ng-container>

                            <!-- Type -->
                            <ng-container matColumnDef="type">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_TYPE' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    <a
                                        *ngIf="duplicatesList.peopleMap[item]"
                                        [routerLink]="['/' + EntityModel.getLinkForEntityType(duplicatesList.peopleMap[item].type), duplicatesList.peopleMap[item].id, 'view']">
                                        {{ duplicatesList.peopleMap[item].type | translate }}
                                    </a>
                                </mat-cell>
                            </ng-container>

                            <!-- First Name -->
                            <ng-container matColumnDef="firstName">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_FIRST_NAME' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    {{ duplicatesList.peopleMap[item]?.firstName }}
                                </mat-cell>
                            </ng-container>

                            <!-- Last Name -->
                            <ng-container matColumnDef="lastName">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_LAST_NAME' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    {{ duplicatesList.peopleMap[item]?.type === EntityType.EVENT ? duplicatesList.peopleMap[item]?.name : duplicatesList.peopleMap[item]?.lastName }}
                                </mat-cell>
                            </ng-container>

                            <!-- Documents -->
                            <ng-container matColumnDef="documents">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_DOCUMENT_NUMBER' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    <span
                                        *ngIf="duplicatesList.peopleMap[item]?.type === EntityType.EVENT; else documentsTemplate"
                                        class="duplicate-records-label-not-applicable">
                                        {{ 'LNG_PAGE_LIST_DUPLICATE_RECORDS_LABEL_NOT_APPLICABLE' | translate }}
                                    </span>
                                    <ng-template
                                        #documentsTemplate>
                                        <span
                                            *ngIf="!getNotEvent(duplicatesList.peopleMap[item])?.documents || getNotEvent(duplicatesList.peopleMap[item])?.documents.length < 1; else docChildTemplate"
                                            class="duplicate-records-label-none">
                                            {{ 'LNG_PAGE_LIST_DUPLICATE_RECORDS_LABEL_NONE' | translate }}
                                        </span>
                                        <ng-template
                                            #docChildTemplate>
                                            <span
                                                *ngFor="let document of getNotEvent(duplicatesList.peopleMap[item])?.documents; let first = first">
                                                {{ document.number ? ( first ? '' : ' / ' ) + document.number : ('LNG_PAGE_LIST_DUPLICATE_RECORDS_LABEL_MISSING' | translate) }}
                                            </span>
                                        </ng-template>
                                    </ng-template>
                                </mat-cell>
                            </ng-container>

                            <!-- Visual Id -->
                            <ng-container matColumnDef="visualId">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">
                                            {{'LNG_ENTITY_FIELD_LABEL_VISUAL_ID' | translate}}
                                        </div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    <span
                                        *ngIf="duplicatesList.peopleMap[item]?.type === EntityType.EVENT; else visualIdTemplate"
                                        class="duplicate-records-label-not-applicable">
                                        {{ 'LNG_PAGE_LIST_DUPLICATE_RECORDS_LABEL_NOT_APPLICABLE' | translate }}
                                    </span>
                                    <ng-template
                                        #visualIdTemplate>
                                        {{getNotEvent(duplicatesList.peopleMap[item])?.visualId}}
                                    </ng-template>
                                </mat-cell>
                            </ng-container>

                            <!-- Age -->
                            <ng-container matColumnDef="age">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_AGE' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    <span
                                        *ngIf="duplicatesList.peopleMap[item]?.type === EntityType.EVENT; else ageTemplate"
                                        class="duplicate-records-label-not-applicable">
                                        {{ 'LNG_PAGE_LIST_DUPLICATE_RECORDS_LABEL_NOT_APPLICABLE' | translate }}
                                    </span>
                                    <ng-template
                                        #ageTemplate>
                                        <app-age-label [age]="getNotEvent(duplicatesList.peopleMap[item])?.age"></app-age-label>
                                    </ng-template>
                                </mat-cell>
                            </ng-container>

                            <!-- Address -->
                            <ng-container matColumnDef="address">
                                <mat-header-cell *matHeaderCellDef>
                                    <div class="table-header-cell">
                                        <div class="column-header">{{'LNG_ENTITY_FIELD_LABEL_ADDRESS' | translate}}</div>
                                    </div>
                                </mat-header-cell>
                                <mat-cell *matCellDef="let item">
                                    {{ duplicatesList.peopleMap[item]?.type === EntityType.EVENT ?
                                        getEvent(duplicatesList.peopleMap[item])?.address.fullAddress :
                                        AddressModel.getCurrentAddress(getNotEvent(duplicatesList.peopleMap[item])?.addresses)?.fullAddress }}
                                </mat-cell>
                            </ng-container>

                            <mat-header-row *matHeaderRowDef="tableVisibleHeaderColumns"></mat-header-row>
                            <mat-row *matRowDef="let item; columns: tableVisibleHeaderColumns"></mat-row>
                        </mat-table>
                    </div>

                    <div
                        fxFlex fxGrow="0">
                        <button
                            *ngIf="hasMergePermission(group)"
                            mat-raised-button color="accent"
                            type="button"
                            [disabled]="!hasAtLeastTwoCheckboxChecked(tableForm)"
                            (click)="mergeCheckedRecords(tableForm)">
                            {{'LNG_COMMON_BUTTON_MERGE' | translate}}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </ng-container>

    <!-- No data -->
    <div
        *ngIf="!refreshingList && isEmptyList"
        class="empty-table-text">
        {{'LNG_COMMON_LABEL_EMPTY_TABLE' | translate}}
    </div>

    <!-- Pages (need to be hidden and not ngIf, otherwise it makes a new duplicate request) -->
    <app-mat-paginator-extended
        [hidden]="refreshingList || isEmptyList"
        [pageIndex]="pageIndex"
        [countData]="duplicatesListCount$ | async"
        [pageSize]="pageSize"
        [pageSizeOptions]="[]"
        (page)="changePage($event)">
    </app-mat-paginator-extended>
</mat-card>
