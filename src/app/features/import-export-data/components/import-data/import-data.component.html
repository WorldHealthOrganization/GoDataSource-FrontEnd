<mat-card class="page-section page-content">

    <!-- Uploading / Saving data -->
    <div
        class="import-data-loading"
        *ngIf="displayLoading">
        <mat-spinner></mat-spinner>
        <span
            *ngIf="progress !== null"
            class="import-data-loading-progress">
            {{ progress }} %
        </span>
    </div>

    <!-- Select / Upload file -->
    <div
        *ngIf="!displayLoading && !importableObject"
        fxFlex fxLayout="column" fxLayoutGap="12px"
        class="import-data">
        <div>
            <input
                hidden
                #importDataBtn
                type="file"
                ng2FileSelect
                [uploader]="uploader"
                [accept]="allowedExtensions"/>

            <div
                fxFlex fxLayoutAlign="center center"
                class="import-data-drop-zone"
                [class.import-data-file-over]="hasFileOver"
                ng2FileDrop
                [uploader]="uploader"
                (fileOver)="hoverDropZone($event)"
                (click)="importDataBtn.click()">
                {{ 'LNG_PAGE_IMPORT_DATA_LABEL_DRAG_AND_DROP_FILE_HERE' | translate:translationData }}
            </div>
        </div>

        <div
            class="import-data-file-or">
            {{ 'LNG_PAGE_IMPORT_DATA_LABEL_OR' | translate }}
        </div>

        <div
            class="import-data-file-input"
            fxFlex fxLayout="row"
            (click)="importDataBtn.click()">
            <div
                class="import-data-file-input-label">
                {{ title | translate:translationData }}
            </div>
            <div
                fxFlex
                class="import-data-file-input-file">
                {{ uploader?.queue.length > 0 ? uploader.queue[0].file.name : ('LNG_PAGE_IMPORT_DATA_LABEL_CHOOSE_FILE' | translate) }}
            </div>
            <div
                class="import-data-file-input-browse">
                {{ 'LNG_PAGE_IMPORT_DATA_BUTTON_BROWSE' | translate }}
            </div>
        </div>

        <div
            fxFlex fxLayout="row" fxLayoutAlign="end">
            <button
                mat-raised-button
                color="primary"
                class="button-primary"
                [disabled]="!uploader || uploader.queue.length < 1"
                (click)="uploadFile()">
                {{ (isOneStep ? 'LNG_PAGE_IMPORT_DATA_BUTTON_IMPORT_FILE' : 'LNG_PAGE_IMPORT_DATA_BUTTON_UPLOAD_FILE') | translate }}
            </button>
        </div>
    </div>

    <!-- Map fields -->
    <div
        *ngIf="!displayLoading && importableObject"
        fxFlex fxLayout="column" fxLayoutGap="30px"
        class="import-data-map-fields">
        <form
            #form="ngForm"
            (submit)="importData(form)">
            <div
                fxFlex fxLayout="row" fxLayoutGap="20px"
                class="import-data-map-fields-header-columns">
                <div fxFlex>
                    {{ 'LNG_PAGE_IMPORT_DATA_LABEL_SOURCE_FILE_INFORMATION' | translate }}
                </div>
                <div fxFlex>
                    {{ 'LNG_PAGE_IMPORT_DATA_LABEL_MODEL_INFORMATION' | translate }}
                </div>
                <div fxFlex="70px">
                    <!-- placeholder -->
                </div>
            </div>
            <div
                *ngFor="let item of mappedFields; let indexMapField = index;">
                <div
                    fxFlex fxLayout="row" fxLayoutGap="20px">
                    <app-form-select
                        [name]="'mapObject[' + indexMapField + '][source]'"
                        app-unique-validator="\]\[source\]$"
                        [required]="true"
                        [(ngModel)]="item.sourceField"
                        [placeholder]="'LNG_PAGE_IMPORT_DATA_LABEL_SELECT_SOURCE' | translate"
                        [options]="importableObject.fileHeadersKeyValue"
                        (optionChanged)="addMapOptionsIfNecessary(item)">
                    </app-form-select>

                    <app-form-select
                        [name]="'mapObject[' + indexMapField + '][destination]'"
                        [required]="true"
                        [(ngModel)]="item.destinationField"
                        [placeholder]="'LNG_PAGE_IMPORT_DATA_LABEL_SELECT_DESTINATION' | translate"
                        [options]="importableObject.modelPropertiesKeyValue"
                        (optionChanged)="addMapOptionsIfNecessary(item)">
                    </app-form-select>

                    <div
                        fxFlex="70px">
                        <button
                            mat-icon-button
                            color="warn"
                            (click)="removeFieldMap(indexMapField)">
                            <span class="xt-icon">delete</span>
                        </button>
                    </div>
                </div>
                <div
                    *ngIf="
                        importableObject.distinctFileColumnValuesKeyValue &&
                        importableObject.distinctFileColumnValuesKeyValue[item.sourceField] &&
                        getModelPropertyValues(item.destinationField)
                    "
                    class="import-data-map-fields-children">
                    <div
                        *ngFor="let mappedOpt of item.mappedOptions; let indexMapOption = index"
                        fxFlex fxLayout="row" fxLayoutGap="20px">
                        <app-form-select
                            [name]="'mapObject[' + indexMapField + '][options][' + indexMapOption + '][sourceOption]'"
                            app-unique-validator
                            [appUniqueValidatorExpression]="'\\[' + indexMapField + '\\]\\[options\\]\\[\\d+\\]\\[sourceOption\\]$'"
                            [required]="true"
                            [(ngModel)]="mappedOpt.sourceOption"
                            [placeholder]="'LNG_PAGE_IMPORT_DATA_LABEL_SELECT_SOURCE' | translate"
                            [options]="importableObject.distinctFileColumnValuesKeyValue[item.sourceField]">
                        </app-form-select>

                        <app-form-select
                            *ngIf="getModelPropertyValues(item.destinationField)"
                            [name]="'mapObject[' + indexMapField + '][options][' + indexMapOption + '][destinationOption]'"
                            [required]="true"
                            [(ngModel)]="mappedOpt.destinationOption"
                            [placeholder]="'LNG_PAGE_IMPORT_DATA_LABEL_SELECT_DESTINATION' | translate"
                            [options]="getModelPropertyValues(item.destinationField)"
                            optionValueKey="id">
                        </app-form-select>

                        <div fxFlex="70px">
                            <button
                                mat-icon-button
                                color="warn"
                                (click)="removeOptionMap(indexMapField, indexMapOption)">
                                <span class="xt-icon">delete</span>
                            </button>
                        </div>
                    </div>

                    <div
                        fxFlex fxLayout="row" fxLayoutAlign="center">
                        <button
                            *ngIf="importableObject.distinctFileColumnValuesKeyValue[item.sourceField] &&
                                item.mappedOptions.length < importableObject.distinctFileColumnValuesKeyValue[item.sourceField].length"
                            mat-raised-button
                            color="primary"
                            class="button-primary"
                            (click)="addNewOptionMap(indexMapField)">
                            <span class="xt-icon">addCircle</span>
                            {{ 'LNG_PAGE_IMPORT_DATA_BUTTON_ADD_NEW_FIELD_OPTION' | translate }}
                        </button>
                    </div>
                </div>
            </div>

            <div
                fxFlex fxLayout="row" fxLayoutAlign="center">
                <button
                    *ngIf="mappedFields.length < importableObject.fileHeadersKeyValue.length"
                    mat-raised-button
                    color="primary"
                    class="button-primary"
                    (click)="addNewFieldMap()">
                    <span class="xt-icon">addCircle</span>
                    {{ 'LNG_PAGE_IMPORT_DATA_BUTTON_ADD_NEW_FIELD' | translate }}
                </button>
            </div>

            <div
                fxFlex fxLayout="row" fxLayoutAlign="end">
                <button
                    mat-raised-button
                    color="primary"
                    class="button-primary"
                    type="submit">
                    {{ 'LNG_PAGE_IMPORT_DATA_BUTTON_IMPORT_FILE' | translate }}
                </button>
            </div>
        </form>
    </div>
</mat-card>
