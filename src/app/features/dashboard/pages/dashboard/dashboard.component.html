<div>
    <app-topnav>
        <ng-container dynamic-section>
            <div fxLayout="row" fxFlex fxLayoutAlign="space-between center">
                <app-breadcrumbs [items]="breadcrumbs"></app-breadcrumbs>

                <div class="topnav-actions">

                    <button mat-raised-button color="accent"
                            [matMenuTriggerFor]="quickActionsMenu">
                        {{'LNG_PAGE_DASHBOARD_REPORTS_BUTTON_LABEL' | translate}} <span class="xt-icon">arrowDown</span>
                    </button>

                    <mat-menu #quickActionsMenu="matMenu">
                        <ng-container>
                            <app-export-button
                                [menuItem]="true"
                                [fileType]="ExportDataExtension.PDF"
                                [label]="'LNG_PAGE_DASHBOARD_CASES_BY_CLASSIFICATION_LOCATION_REPORT_LABEL' | translate"
                                [message]="'LNG_PAGE_DASHBOARD_CASES_BY_CLASSIFICATION_LOCATION_REPORT_LABEL' | translate"
                                [url]="casesByClassificationAndLocationReportUrl"
                                [fileName]="'LNG_PAGE_DASHBOARD_CASES_BY_CLASSIFICATION_LOCATION_REPORT_LABEL' | translate"
                                (exportStart)="showLoadingDialog()"
                                (exportFinished)="closeLoadingDialog()"
                                [queryBuilder]="qbCaseByClassification()">
                            </app-export-button>

                            <app-export-button
                                [menuItem]="true"
                                [fileType]="ExportDataExtension.PDF"
                                [label]="'LNG_PAGE_DASHBOARD_CONTACTS_FOLLOWUP_SUCCESS_RATE_REPORT_LABEL' | translate"
                                [message]="'LNG_PAGE_DASHBOARD_CONTACTS_FOLLOWUP_SUCCESS_RATE_REPORT_LABEL' | translate"
                                [url]="contactsFollowupSuccessRateReportUrl"
                                [fileName]="'LNG_PAGE_DASHBOARD_CONTACTS_FOLLOWUP_SUCCESS_RATE_REPORT_LABEL' | translate"
                                (exportStart)="showLoadingDialog()"
                                (exportFinished)="closeLoadingDialog()"
                                [queryBuilder]="qbContactsFollowUpSuccessRate()">
                            </app-export-button>

                            <button
                                *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                                mat-menu-item
                                (click)="generateEpiCurveReport()">
                                {{'LNG_PAGE_DASHBOARD_EPI_CURVE_REPORT_LABEL' | translate}}
                            </button>

                            <button
                                mat-menu-item
                                (click)="generateKpisReport()">
                                {{'LNG_PAGE_DASHBOARD_KPIS_REPORT_LABEL' | translate}}
                            </button>
                        </ng-container>
                    </mat-menu>
                </div>
            </div>
        </ng-container>
    </app-topnav>

    <ng-container *ngIf="noOutbreaksInSystem">
        <mat-card class="page-content page-section">
            {{'LNG_PAGE_DASHBOARD_NO_OUTBREAKS_MESSAGE' | translate}}
        </mat-card>
    </ng-container>

    <ng-container *ngIf="!noOutbreaksInSystem">
        <!-- Side filters -->
        <app-side-filters
            [filterOptions]="availableSideFilters"
            (filtersCollected)="applySideFilters($event)"
            [savedFiltersType]="savedFiltersType"
            [savedFilters]="availableSavedFilters$ | async"
            [fixedFilters]="true">
        </app-side-filters>

        <!-- Dashboard items -->
        <div class="page-content">

            <div
                fxFlex fxLayout="row" fxLayoutAlign="space-between">

                <div fxFlex="33">
                    <mat-card class="dashboard-gauge">
                        <div class="other-kpi-header">{{'LNG_PAGE_DASHBOARD_CASE_SUMMARY_TITLE' | translate}}</div>
                        <!-- case summary pie chart -->
                        <div fxLayoutAlign="center">
                            <app-case-summary-dashlet
                                *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-case-summary-dashlet>
                        </div>
                    </mat-card>
                </div>

                <div fxFlex="33">
                    <!-- cases by geographic location - pie chart -->
                    <mat-card class="dashboard-gauge">
                        <div class="other-kpi-header">{{'LNG_PAGE_DASHBOARD_CASE_BY_GEOGRAPHIC_LOCATION_TITLE' | translate}}</div>
                        <div fxLayoutAlign="center">
                            <app-case-by-geographic-location-dashlet
                                *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-case-by-geographic-location-dashlet>
                        </div>
                    </mat-card>
                </div>

                <div fxFlex="33">
                    <mat-card class="dashboard-gauge">
                        <div class="other-kpi-header">{{'LNG_PAGE_DASHBOARD_CASE_HOSPITALIZATION_TITLE' | translate}}</div>
                        <!-- case hospitalization status pie chart -->
                        <div fxLayoutAlign="center">
                            <app-cases-hospitalized-pie-chart-dashlet
                                *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-hospitalized-pie-chart-dashlet>
                        </div>
                    </mat-card>
                </div>

            </div>
            <!--</mat-card>-->

            <!-- Histogram - chains of transmission -->
            <mat-card class="page-section">
                <div class="other-kpi-header">{{'LNG_PAGE_DASHBOARD_HISTOGRAM_CHAINS_OF_TRANSMISSION_SIZE_TITLE' |
                    translate}}
                </div>

                <!-- histogram - chains of transmission size -->
                <app-histogram-transmission-chains-size-dashlet
                    *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                    [globalFilterDate]="globalFilterDate"
                    [globalFilterLocationId]="globalFilterLocationId">
                </app-histogram-transmission-chains-size-dashlet>
            </mat-card>

            <mat-card class="page-section">
                <div class="other-kpi-header">{{'LNG_PAGE_DASHBOARD_EPI_CURVE_TITLE' | translate}}</div>

                <!-- epi curve -->
                <app-epi-curve-dashlet
                    *ngIf="hasReadCasePermissions() && hasReadReportPermissions()"
                    [globalFilterDate]="globalFilterDate"
                    [globalFilterLocationId]="globalFilterLocationId">
                </app-epi-curve-dashlet>
            </mat-card>

            <!-- KPIs -->
            <div #kpiSection>
                <mat-card
                    *ngFor="let group of kpiGroups"
                    class="page-section">

                    <!-- KPIs section header -->
                    <div class="dashlet-kpi-header" fxLayout="row" fxLayoutAlign="space-between center">
                        <div>
                            {{group.title | translate}}
                        </div>

                        <div>
                            <button mat-icon-button [disableRipple]="true" [matMenuTriggerFor]="actionsMenu">
                                <span class="xt-icon">menu</span>
                            </button>

                            <mat-menu #actionsMenu="matMenu">
                                <button class="dashboard-kpi-menu-item" mat-menu-item (click)="showAllDashlets(group.id)">
                                    {{'LNG_PAGE_DASHBOARD_KPI_SECTION_MENU_SHOW_ALL_LABEL' | translate}}
                                </button>
                            </mat-menu>
                        </div>
                    </div>

                    <!-- KPIs list -->
                    <div fxLayout="row wrap">
                        <ng-container *ngFor="let dashlet of group.dashlets">
                            <!-- Cases who have died -->
                            <app-cases-deceased-dashlet
                                *ngIf="dashlet === DashboardDashlet.CASES_DECEASED &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-deceased-dashlet>

                            <!-- Cases hospitalised -->
                            <app-cases-hospitalised-dashlet
                                *ngIf="dashlet === DashboardDashlet.CASES_HOSPITALISED &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-hospitalised-dashlet>

                            <!-- Cases with Less than x Contacts -->
                            <app-cases-less-contacts-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CASES_WITH_LESS_THAN_X_CONTACTS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-less-contacts-dashlet>

                            <!-- New cases detected in the previous x days among contacts -->
                            <app-new-cases-previous-days-contacts-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.NEW_CASES_IN_THE_PREVIOUS_X_DAYS_AMONG_KNOWN_CONTACTS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-new-cases-previous-days-contacts-dashlet>

                            <!-- Cases refusing to be transferred to a treatment unit -->
                            <app-cases-refusing-treatment-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.SUSPECT_CASES_REFUSING_TO_BE_TRANSFERRED_TO_A_TREATMENT_UNIT &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-refusing-treatment-dashlet>

                            <!-- New cases in previous x days in known transmission chains -->
                            <app-new-cases-previous-days-transmission-chains-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.NEW_CASES_IN_THE_PREVIOUS_X_DAYS_OUTSIDE_THE_TRANSMISSION_CHAINS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-new-cases-previous-days-transmission-chains-dashlet>

                            <!-- Suspect Cases where the lab result is pending -->
                            <app-cases-pending-lab-results-dashlet
                                *ngIf="
                                dashlet === DashboardDashlet.SUSPECT_CASES_WITH_PENDING_LAB_RESULT &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-pending-lab-results-dashlet>

                            <!-- Number of cases who are not identified though known contact list -->
                            <app-cases-not-identified-through-contacts-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CASES_NOT_IDENTIFIED_THROUGH_CONTACTS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-cases-not-identified-through-contacts-dashlet>

                            <!-- Contacts per case mean -->
                            <app-contacts-per-case-mean-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_PER_CASE_MEAN &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-per-case-mean-dashlet>

                            <!-- Contacts per case median -->
                            <app-contacts-per-case-median-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_PER_CASE_MEDIAN &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-per-case-median-dashlet>

                            <!-- Contacts on the follow-up list -->
                            <app-contacts-on-followup-list-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_ON_THE_FOLLOW_UP_LIST &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-on-followup-list-dashlet>

                            <!-- Contacts Lost to follow-up -->
                            <app-contacts-lost-to-follow-up-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_LOST_TO_FOLLOW_UP &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-lost-to-follow-up-dashlet>

                            <!-- Contacts Not Seen -->
                            <app-contacts-not-seen-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_NOT_SEEN_IN_X_DAYS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-not-seen-dashlet>

                            <!-- Number of contacts becoming cases in period & location -->
                            <app-contacts-become-cases-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_BECOMING_CASES_IN_TIME_AND_SPACE &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-become-cases-dashlet>

                            <!-- Contacts seen each day -->
                            <app-contacts-seen-each-day-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_SEEN_EACH_DAY &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-seen-each-day-dashlet>

                            <!-- Contacts with successful follow-ups -->
                            <app-contacts-with-successful-follow-ups-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.CONTACTS_WITH_SUCCESSFUL_FOLLOW_UP &&
                                    isDashletVisible(dashlet) &&
                                    hasReadContactPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-contacts-with-successful-follow-ups-dashlet>

                            <!-- number of independent chains of transmission -->
                            <app-independent-transmission-chains-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.INDEPENDENT_TRANSMISSION_CHAINS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadCasePermissions() && hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-independent-transmission-chains-dashlet>

                            <!-- Number of active chains of transmission -->
                            <app-number-of-active-chains-of-transmission-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.ACTIVE_TRANSMISSION_CHAINS &&
                                    isDashletVisible(dashlet) &&
                                    hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-number-of-active-chains-of-transmission-dashlet>

                            <!-- Number of new chains of transmission from registered contacts who have became cases-->
                            <app-new-chains-of-transmission-from-registered-contacts-dashlet
                                *ngIf="
                                    dashlet === DashboardDashlet.TRANSMISSION_CHAINS_FROM_CONTACTS_WHO_BECAME_CASES &&
                                    isDashletVisible(dashlet) &&
                                    hasReadReportPermissions()
                                "
                                (hide)="hideDashlet(dashlet)"
                                (moveBefore)="moveDashletBefore(dashlet)"
                                (moveAfter)="moveDashletAfter(dashlet)"
                                [globalFilterDate]="globalFilterDate"
                                [globalFilterLocationId]="globalFilterLocationId">
                            </app-new-chains-of-transmission-from-registered-contacts-dashlet>
                        </ng-container>
                    </div>
                </mat-card>
            </div>

            <canvas id="tempCanvas"></canvas>

        </div>
    </ng-container>

</div>
