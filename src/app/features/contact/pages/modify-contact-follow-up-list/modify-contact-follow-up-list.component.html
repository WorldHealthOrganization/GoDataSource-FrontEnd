<app-topnav [activeOutbreakEditable]="false">
    <ng-container dynamic-section>
        <app-breadcrumbs [items]="breadcrumbs"></app-breadcrumbs>
    </ng-container>
</app-topnav>

<div class="page-content">

    <mat-horizontal-stepper
        linear
        #stepper
        (selectionChange)="onChangeStep($event, [followDetailsForm, followQuestionnaireForm])"
    >
        <!-- Details step -->
        <mat-step [stepControl]="followDetailsForm">
            <form #followDetailsForm="ngForm" fxLayout="column">
                <ng-template matStepLabel>
                    {{'LNG_PAGE_MODIFY_FOLLOW_UPS_LIST_TAB_DETAILS_TITLE'| translate}}
                </ng-template>

                <app-selected-contacts-list
                    [contacts]="selectedContacts"
                    [followUpDates]="followUpDates"
                ></app-selected-contacts-list>

                <mat-card class="page-section">
                    <div fxLayout="column">
                        <div fxLayout="row" fxLayoutGap="20px">
                            <app-form-datepicker
                                name="date"
                                [ngModel]="followUp.date"
                                [placeholder]="'LNG_FOLLOW_UP_FIELD_LABEL_DATE' | translate"
                                tooltip="LNG_FOLLOW_UP_FIELD_LABEL_DATE_DESCRIPTION"
                                app-date-validator>
                            </app-form-datepicker>

                            <app-form-slide-toggle
                                name="targeted"
                                [ngModel]="followUp.targeted"
                                [label]="'LNG_FOLLOW_UP_FIELD_LABEL_TARGETED' | translate"
                                tooltip="LNG_FOLLOW_UP_FIELD_LABEL_TARGETED_DESCRIPTION">
                            </app-form-slide-toggle>

                            <app-form-select
                                name="statusId"
                                [ngModel]="followUp.statusId"
                                [placeholder]="'LNG_FOLLOW_UP_FIELD_LABEL_STATUS_ID' | translate"
                                tooltip="LNG_FOLLOW_UP_FIELD_LABEL_STATUS_ID_DESCRIPTION"
                                [options]="dailyStatusTypeOptions$ | async"
                                optionLabelKey="label"
                                optionValueKey="value">
                            </app-form-select>

                            <app-form-select
                                name="teamId"
                                [ngModel]="followUp.teamId"
                                [placeholder]="'LNG_FOLLOW_UP_FIELD_LABEL_TEAM' | translate"
                                tooltip="LNG_FOLLOW_UP_FIELD_LABEL_TEAM_DESCRIPTION"
                                [options]="teamsList$ | async"
                                optionLabelKey="name"
                                optionValueKey="id">
                            </app-form-select>
                        </div>
                    </div>
                </mat-card>

                <div class="stepper-navigation-buttons">
                    <button mat-raised-button color="accent" matStepperNext>
                        {{'LNG_STEPPER_BUTTON_NEXT' | translate}}
                    </button>
                </div>
            </form>
        </mat-step>

        <!-- Questionnaire step -->
        <mat-step [stepControl]="followQuestionnaireForm">
            <form #followQuestionnaireForm="ngForm" fxLayout="column">
                <ng-template matStepLabel>
                    {{'LNG_PAGE_MODIFY_FOLLOW_UPS_LIST_TAB_QUESTIONNAIRE_TITLE'| translate}}
                </ng-template>

                <app-selected-contacts-list
                    [contacts]="selectedContacts"
                ></app-selected-contacts-list>

                <!-- Questionnaire section -->
                <app-form-fill-questionnaire
                    name="questionnaireAnswers"
                    [ngModel]="followUp.questionnaireAnswers"
                    [questions]="selectedOutbreak?.contactFollowUpTemplate"
                    [skipRequired]="true"
                ></app-form-fill-questionnaire>

                <div class="stepper-navigation-buttons">
                    <button mat-raised-button type="button" matStepperPrevious>
                        {{'LNG_STEPPER_BUTTON_BACK' | translate}}
                    </button>
                    <button mat-raised-button color="accent" matStepperNext>
                        {{'LNG_STEPPER_BUTTON_NEXT' | translate}}
                    </button>
                </div>
            </form>
        </mat-step>

        <!-- Final step -->
        <mat-step>
            <ng-template matStepLabel>
                {{'LNG_STEPPER_FINAL_STEP_LABEL' | translate}}
            </ng-template>

            <app-selected-contacts-list
                [contacts]="selectedContacts"
            ></app-selected-contacts-list>

            <mat-card
                class="page-section"
                fxFlex fxLayout="column"
            >
                <span class="changes-title">
                    {{'LNG_PAGE_MODIFY_FOLLOW_UPS_LIST_CHANGES_FOR_SELECTED_FOLLOW_UPS' | translate}}
                </span>

                <div
                    *ngIf="currentDirtyFields.date !== undefined"
                    fxLayout="row" fxLayoutGap="15px"
                >
                    <span>{{'LNG_FOLLOW_UP_FIELD_LABEL_DATE' | translate}}:</span>
                    <span>{{currentDirtyFields.date | dateDefault}}</span>
                </div>

                <div
                    *ngIf="currentDirtyFields.targeted !== undefined"
                    fxLayout="row" fxLayoutGap="15px"
                >
                    <span>{{'LNG_FOLLOW_UP_FIELD_LABEL_TARGETED' | translate}}:</span>
                    <app-yes-no-label [value]="currentDirtyFields.targeted"></app-yes-no-label>
                </div>

                <div
                    *ngIf="currentDirtyFields.statusId !== undefined"
                    fxLayout="row" fxLayoutGap="15px"
                >
                    <span>{{'LNG_FOLLOW_UP_FIELD_LABEL_STATUS_ID' | translate}}:</span>
                    <app-list-item-label
                        [options]="dailyStatusTypeOptions$ | async"
                        optionLabelKey="label"
                        optionValueKey="value"
                        [value]="currentDirtyFields.statusId"
                    ></app-list-item-label>
                </div>

                <div
                    *ngIf="currentDirtyFields.teamId !== undefined"
                    fxLayout="row" fxLayoutGap="15px"
                >
                    <span>{{'LNG_FOLLOW_UP_FIELD_LABEL_TEAM' | translate}}:</span>
                    <app-list-item-label
                        [options]="teamsList$ | async"
                        optionLabelKey="name"
                        optionValueKey="id"
                        [value]="currentDirtyFields.teamId"
                    ></app-list-item-label>
                </div>

                <ng-container *ngIf="currentDirtyFields.questionnaireAnswers">
                    <span class="changes-title">
                        {{'LNG_PAGE_MODIFY_FOLLOW_UPS_LIST_CHANGES_FOR_SELECTED_FOLLOW_UPS_QUESTIONNAIRE' | translate}}
                    </span>

                    <div
                        *ngFor="let variable of Object.keys(currentDirtyFields.questionnaireAnswers)"
                        fxLayout="row" fxLayoutGap="15px"
                    >
                        <div>{{variable}}: </div>
                        <div
                            fxFlex>
                            <div
                                *ngFor="let answerData of currentDirtyFields.questionnaireAnswers[variable]"
                                fxLayout="row" fxLayoutGap="15px"
                            >
                                <span
                                    *ngIf="answerData.date">{{answerData.date | dateDefault}} :</span>
                                <span>{{answerData.value}}</span>
                            </div>
                        </div>
                    </div>
                </ng-container>
            </mat-card>

            {{'LNG_STEPPER_FINAL_STEP_TEXT' | translate}}

            <div class="stepper-navigation-buttons">
                <button mat-raised-button type="button" matStepperPrevious>
                    {{'LNG_STEPPER_BUTTON_BACK' | translate}}
                </button>
                <button
                    type="button"
                    mat-raised-button
                    color="accent"
                    (click)="updateFollowUps([followDetailsForm, followQuestionnaireForm])">
                    {{'LNG_PAGE_MODIFY_FOLLOW_UPS_LIST_ACTION_UPDATE_FOLLOW_UPS_BUTTON' | translate}}
                </button>
            </div>
        </mat-step>
    </mat-horizontal-stepper>
</div>
