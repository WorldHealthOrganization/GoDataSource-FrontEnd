<div class="form-select-groups-container form-element {{ tooltip ? 'form-select-groups-tooltip' : '' }}"
     [id]="identifier" [ngClass]="{invalid: (invalid)}">

    <mat-form-field>
        <mat-select
            #selectGroup
            panelClass="select-group-group-panel"
            [(ngModel)]="value"
            [attr.name]="name"
            [required]="required"
            [placeholder]="placeholder"
            (blur)="onBlur()"
            [disabled]="disabled"
            multiple="true"
            (valueChange)="valueChanged($event)"
            (openedChange)="openedChange($event)">
            <!-- Render display selected -->
            <mat-select-trigger
                class="select-group-group-selected">
                {{ selectTriggerText }}
            </mat-select-trigger>

            <!-- Needed to actually select partial records when nothing selectable is visible -->
            <mat-option
                *ngFor="let defaultValue of defaultValues"
                [value]="defaultValue[groupOptionValueKey]"
                disabled="true"
                [matTooltip]="defaultValue[groupOptionTooltipKey] | translate">
                {{ defaultValue[groupOptionLabelKey] | translate }}
            </mat-option>

            <!-- Render select panel -->
            <mat-optgroup
                *ngFor="let group of groups"
                (click)="clickedGroup($event, group, 'select-group-line')">

                <!-- Group label -->
                <div
                    class="select-group-line"
                    [matTooltip]="group[groupTooltipKey] | translate">
                    <span class="xt-icon">{{ expandedGroups[group[groupValueKey]] ? 'thinArrowDown' : 'thinArrowRight' }}</span>
                    <span
                        class="select-group-line-label">
                        {{ group[groupLabelKey] | translate }}
                    </span>
                </div>

                <!-- Collapsed - Child options -->
                <ng-container
                    *ngIf="!expandedGroups[group[groupValueKey]]">
                    <mat-option
                        class="select-group-option"
                        [disabled]="!othersAreChecked(group[groupValueKey], groupKeys.partial[group[groupValueKey]])"
                        [value]="groupKeys.none[group[groupValueKey]]"
                        [matTooltip]="groupNoneTooltip | translate"
                        (onSelectionChange)="uncheckOthers($event)">
                        {{ groupNoneLabel | translate }}
                    </mat-option>
                    <mat-option
                        class="select-group-option select-group-option-partial"
                        disabled="true"
                        [value]="groupKeys.partial[group[groupValueKey]]"
                        [matTooltip]="groupPartialTooltip | translate"
                        (onSelectionChange)="uncheckOthers($event)"
                        (click)="clickedGroup($event, group, 'select-group-option-partial')">
                        {{ groupPartialLabel | translate:{ partialLabels: partialOptions[groupKeys.partial[group[groupValueKey]]] } }}
                    </mat-option>
                    <mat-option
                        class="select-group-option"
                        [disabled]="!othersAreChecked(groupKeys.none[group[groupValueKey]], groupKeys.partial[group[groupValueKey]])"
                        [value]="group[groupValueKey]"
                        [matTooltip]="groupAllTooltip | translate"
                        (onSelectionChange)="uncheckOthers($event)">
                        {{ groupAllLabel | translate }}
                    </mat-option>
                </ng-container>

                <!-- Expanded - Child options -->
                <ng-container
                    *ngIf="expandedGroups[group[groupValueKey]]">
                    <mat-option
                        *ngFor="let option of group[groupOptionsKey]"
                        [value]="option[groupOptionValueKey]"
                        [matTooltip]="tooltipTranslations[option[groupOptionTooltipKey]]"
                        (onSelectionChange)="checkedChildOption($event)">
                        <div
                            fxLayout="row"
                            [innerHTML]="labelTranslations[option[groupOptionLabelKey]]">
                        </div>
                    </mat-option>
                </ng-container>
            </mat-optgroup>
        </mat-select>

        <span
            *ngIf="tooltip"
            #tooltipCtrl="matTooltip"
            [matTooltip]="tooltip"
            class="xt-icon form-icon"
            (click)="displayTooltip($event, tooltipCtrl)"
        >
            help
        </span>
    </mat-form-field>

    <app-form-validation
        *ngIf="invalid"
        [controlContainer]="controlContainer"
        [controlName]="name"
        [messages]="failures">
    </app-form-validation>
</div>
