<div class="side-filters">

    <button class="sidenav-toggle" mat-raised-button (click)="openSideNav()">
        <span class="xt-icon">filter</span>
    </button>

    <div class="page-overlay mat-drawer-backdrop" [class.mat-drawer-shown]="sideNav.opened"
         (click)="closeSideNav()"></div>

    <mat-sidenav-container>

        <mat-sidenav #sideNav mode="over" fixedInViewport>

            <form #form="ngForm" (submit)="apply(form)">
                <!-- Filters -->
                <div *ngIf="filterOptions.length > 0" class="section filters-section" fxLayout="column">

                    <div class="title">
                        {{'LNG_SIDE_FILTERS_TITLE' | translate}}
                    </div>

                    <div class="actions">

                        <div fxFlex fxLayout="row" class="switch-buttons">
                            <button fxFlex type="button" mat-raised-button
                                    [color]="isFilterOperator(RequestFilterOperator.AND) ? 'primary' : ''"
                                    (click)="setFilterOperator(RequestFilterOperator.AND)">
                                {{'LNG_SIDE_FILTERS_OPERATOR_LABEL_AND' | translate}}
                            </button>
                            <button fxFlex type="button" mat-raised-button
                                    [color]="isFilterOperator(RequestFilterOperator.OR) ? 'primary' : ''"
                                    (click)="setFilterOperator(RequestFilterOperator.OR)">
                                {{'LNG_SIDE_FILTERS_OPERATOR_LABEL_OR' | translate}}
                            </button>

                            <input type="hidden" name="filter[operator]" [(ngModel)]="appliedFilterOperator"/>
                        </div>
                    </div>

                    <div *ngFor="let filter of appliedFilters; let i = index" class="applied-filter" fxLayout="column">

                        <div *ngIf="i > 0" class="operator">
                            {{appliedFilterOperator}}
                        </div>

                        <div class="filter-container" fxLayout="row" fxLayoutAlign="start center">
                            <mat-card class="filter-details" fxFlex>

                                <!-- Filter Type -->
                                <app-form-select
                                    [name]="'filter[filters][' + i + '][filter]'"
                                    [(ngModel)]="filter.filter"
                                    [placeholder]="'LNG_LAYOUT_LIST_DEFAULT_FILTER_PLACEHOLDER' | translate"
                                    [options]="filterOptions"
                                    optionLabelKey="fieldLabel"
                                    optionLabelPrefixKey="relationshipLabel"
                                    optionValueKey="self"
                                    [clearable]="false"
                                    [disabled]="filter.readonly">
                                </app-form-select>

                                <!-- Filter Comparator -->
                                <app-form-select
                                    *ngIf="filter.filter && filter.hasMoreThanOneComparator"
                                    [name]="'filter[filters][' + i + '][comparator]'"
                                    [(ngModel)]="filter.comparator"
                                    [placeholder]="'LNG_SIDE_FILTERS_COMPARATOR_LABEL' | translate"
                                    [options]="filter.allowedComparators[filter.filter.type]"
                                    [clearable]="false">
                                </app-form-select>

                                <!-- TEXT Filter -->
                                <app-form-input
                                    *ngIf="
                                        filter.filter?.type === FilterType.TEXT || (
                                            filter.filter?.type === FilterType.ADDRESS &&
                                            filter.comparator === FilterComparator.CONTAINS
                                        )"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [(ngModel)]="filter.value"
                                    [placeholder]="'LNG_SIDE_FILTERS_COMPARATOR_LABEL_KEYWORD' | translate">
                                </app-form-input>

                                <!-- SELECT / MULTI-SELECT Filter -->
                                <app-form-select
                                    *ngIf="filter.filter?.type === FilterType.SELECT || filter.filter?.type === FilterType.MULTISELECT"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [(ngModel)]="filter.value"
                                    [placeholder]="'LNG_LAYOUT_LIST_DEFAULT_FILTER_PLACEHOLDER' | translate"
                                    [options]="filter.filter.options$ | async"
                                    [multiple]="filter.filter.type === FilterType.MULTISELECT"
                                    [allowSelectionOfDisabledItems]="true"
                                    [displayInvisibleItems]="true">
                                </app-form-select>

                                <!-- NUMBER / AGE RANGE Filter -->
                                <app-form-range
                                    *ngIf="filter.filter?.type === FilterType.RANGE_NUMBER || filter.filter?.type === FilterType.RANGE_AGE"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [ngModel]="filter.value"
                                    (changed)="filter.value = $event;"
                                    [fromVisible]="
                                        filter.comparator === FilterComparator.BETWEEN ||
                                        filter.comparator === FilterComparator.AFTER"
                                    [toVisible]="
                                        filter.comparator === FilterComparator.BETWEEN ||
                                        filter.comparator === FilterComparator.BEFORE"
                                    [step]="filter.filter?.type === FilterType.RANGE_AGE ? 0.1 : undefined"
                                    [min]="filter.filter?.type === FilterType.RANGE_AGE ? 0 : undefined"
                                    [max]="filter.filter?.type === FilterType.RANGE_AGE ? Constants.DEFAULT_AGE_MAX_YEARS : undefined"
                                    [fromPlaceholder]="filter.filter?.type === FilterType.RANGE_AGE ? 'LNG_AGE_FIELD_FILTER_LABEL_FROM' : 'LNG_FORM_RANGE_FIELD_LABEL_FROM'"
                                    [toPlaceholder]="filter.filter?.type === FilterType.RANGE_AGE ? 'LNG_AGE_FIELD_FILTER_LABEL_TO' : 'LNG_FORM_RANGE_FIELD_LABEL_TO'">
                                </app-form-range>

                                <!-- DATE -->
                                <app-form-datepicker
                                    *ngIf="filter.filter?.type === FilterType.DATE"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [(ngModel)]="filter.value"
                                    [placeholder]="'LNG_LAYOUT_LIST_DEFAULT_FILTER_PLACEHOLDER' | translate">
                                </app-form-datepicker>

                                <!-- DATE RANGE Filter-->
                                <app-form-daterange
                                    *ngIf="filter.filter?.type === FilterType.RANGE_DATE"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [ngModel]="filter.value"
                                    (changed)="filter.value = $event;"
                                    [startDateVisible]="filter.comparator === FilterComparator.BETWEEN || filter.comparator === FilterComparator.AFTER"
                                    [endDateVisible]="filter.comparator === FilterComparator.BETWEEN || filter.comparator === FilterComparator.BEFORE">
                                </app-form-daterange>

                                <!-- Address Location / Location -->
                                <app-form-location-dropdown
                                    *ngIf="(filter.filter?.type === FilterType.ADDRESS || filter.filter?.type === FilterType.LOCATION) && filter.comparator === FilterComparator.LOCATION"
                                    [name]="'filter[filters][' + i + '][value]'"
                                    [ngModel]="filter.value"
                                    [placeholder]="'LNG_SIDE_FILTERS_COMPARATOR_LABEL_LOCATION' | translate"
                                    [multiple]="filter.filter?.multipleOptions"
                                    [useOutbreakLocations]="true"
                                    (changed)="filter.value = $event;">
                                </app-form-location-dropdown>

                                <!-- Address Within Radius -->
                                <ng-container
                                    *ngIf="filter.filter?.type === FilterType.ADDRESS &&
                                        filter.comparator === FilterComparator.WITHIN">
                                    <input
                                        [name]="'filter[filters][' + i + '][extraValues][location]'"
                                        [ngModel]="filter.extraValues.location"
                                        type="hidden"/>

                                    <app-form-location-dropdown
                                        [name]="'filter[filters][' + i + '][value]'"
                                        [ngModel]="filter.value"
                                        [placeholder]="'LNG_SIDE_FILTERS_COMPARATOR_LABEL_LOCATION' | translate"
                                        [multiple]="false"
                                        [useOutbreakLocations]="true"
                                        (changed)="filter.value = $event;"
                                        (itemChanged)="filter.extraValues.location = $event;">
                                    </app-form-location-dropdown>

                                    <app-form-input
                                        [name]="'filter[filters][' + i + '][extraValues][radius]'"
                                        [(ngModel)]="filter.extraValues.radius"
                                        [placeholder]="'LNG_SIDE_FILTERS_COMPARATOR_LABEL_WITHIN_MAX_DISTANCE' | translate">
                                    </app-form-input>
                                </ng-container>
                            </mat-card>

                            <!-- Delete filter item -->
                            <button
                                *ngIf="!filter.readonly"
                                class="filter-details-delete-button"
                                type="button" mat-icon-button
                                (click)="deleteFilter(i)">
                                <span class="xt-icon">delete</span>
                            </button>
                        </div>

                    </div>

                    <button type="button" mat-button color="primary" class="add-side-filter" (click)="addFilter()">
                        {{'LNG_SIDE_FILTERS_ADD_ANOTHER_FILTER_BUTTON' | translate}}
                    </button>

                </div>

                <!-- Sort Criteria -->
                <div
                    *ngIf="sortOptions.length > 0"
                    class="section sort-section"
                    fxLayout="column">

                    <div class="title">
                        {{'LNG_SIDE_FILTERS_SECTION_SORT_TITLE' | translate}}
                    </div>

                    <div
                        *ngFor="let sort of appliedSort; let i = index"
                        class="applied-sort"
                        fxLayout="column">

                        <div
                            class="sort-container"
                            fxLayout="row"
                            fxLayoutAlign="start center">
                            <mat-card
                                class="sort-details"
                                fxFlex>

                                <!-- Sort By Field -->
                                <app-form-select
                                    [name]="'sortBy[items][' + i + '][sort]'"
                                    [(ngModel)]="sort.sort"
                                    [placeholder]="'LNG_SIDE_FILTERS_SORT_BY_PLACEHOLDER' | translate"
                                    [options]="sortOptions"
                                    optionLabelKey="fieldLabel"
                                    optionValueKey="self"
                                    [clearable]="false">
                                </app-form-select>

                                <!-- Sort Direction ( ASC / DESC ) -->
                                <app-form-select
                                    *ngIf="sort.sort"
                                    [name]="'sortBy[items][' + i + '][direction]'"
                                    [(ngModel)]="sort.direction"
                                    [placeholder]="'LNG_SIDE_FILTERS_SORT_DIRECTION_LABEL' | translate"
                                    [options]="sortDirections"
                                    [clearable]="false">
                                </app-form-select>
                            </mat-card>

                            <!-- Delete sort item -->
                            <button
                                class="sort-details-delete-button"
                                type="button" mat-icon-button
                                (click)="deleteSort(i)">
                                <span class="xt-icon">delete</span>
                            </button>

                        </div>
                    </div>

                    <button
                        class="add-side-filter"
                        type="button"
                        mat-button
                        color="primary"
                        (click)="addSort()">
                        {{'LNG_SIDE_FILTERS_ADD_ANOTHER_SORT_BUTTON' | translate}}
                    </button>

                </div>

                <div class="buttons-container">
                    <button
                        *ngIf="appliedFilters.length > 0 || appliedSort.length > 0"
                        class="button-primary stretched-button"
                        mat-raised-button
                        color="primary"
                        type="submit">
                        {{'LNG_SIDE_FILTERS_APPLY_FILTERS_BUTTON' | translate}}
                    </button>

                    <button
                        mat-raised-button
                        class="side-filters-reset-button"
                        type="button"
                        (click)="reset()">
                        {{'LNG_COMMON_BUTTON_RESET_FILTERS' | translate}}
                    </button>
                </div>


            </form>

        </mat-sidenav>

    </mat-sidenav-container>

</div>
